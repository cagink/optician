<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ðŸ§­ OptiTools Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/react-router-dom@6/umd/react-router-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script>
      // âœ… Ensure GitHub Pages always loads at #/
      if (!location.hash) {
        location.replace(location.href + "#/");
      }
    </script>
  </head>
  <body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <div id="root"></div>
    <script type="text/babel">
      const { HashRouter, Routes, Route, Link } = ReactRouterDOM;

      function Navbar() {
        return (
          <nav className="bg-blue-600 text-white px-6 py-4 flex justify-between">
            <div className="font-bold">OptiTools Hub</div>
            <div className="space-x-4">
              <Link to="/" className="hover:underline">Home</Link>
              <Link to="/calculator" className="hover:underline">Calculator</Link>
              <Link to="/database" className="hover:underline">Database</Link>
              <Link to="/test" className="hover:underline">Color Test</Link>
            </div>
          </nav>
        );
      }

      function Home() {
        return (
          <div className="p-6">
            <h1 className="text-3xl font-bold mb-4">Welcome to OptiTools Hub</h1>
            <p className="mb-2">Choose a tool from the navigation above:</p>
            <ul className="list-disc ml-6">
              <li>Prescription Transposition Calculator</li>
              <li>Contact Lens Database & Recommendations</li>
              <li>Color Blindness Test</li>
            </ul>
          </div>
        );
      }

      function Calculator() {
        const [sph, setSph] = React.useState("");
        const [cyl, setCyl] = React.useState("");
        const [axis, setAxis] = React.useState("");
        const [result, setResult] = React.useState(null);

        const transpose = () => {
          let s = parseFloat(sph) || 0;
          let c = parseFloat(cyl) || 0;
          let a = parseInt(axis) || 0;
          if (!c) { setResult("No cylinder to transpose."); return; }
          let newS = s + c;
          let newC = -c;
          let newA = (a + 90) % 180;
          setResult(`SPH: ${newS.toFixed(2)}, CYL: ${newC.toFixed(2)}, AXIS: ${newA}`);
        };

        return (
          <div className="p-6">
            <h2 className="text-2xl font-bold mb-4">Prescription Transposition</h2>
            <div className="space-y-2">
              <input className="border p-2 w-40" placeholder="Sphere" value={sph} onChange={e => setSph(e.target.value)} />
              <input className="border p-2 w-40" placeholder="Cylinder" value={cyl} onChange={e => setCyl(e.target.value)} />
              <input className="border p-2 w-40" placeholder="Axis" value={axis} onChange={e => setAxis(e.target.value)} />
              <button onClick={transpose} className="bg-blue-600 text-white px-4 py-2 rounded">Transpose</button>
            </div>
            {result && <div className="mt-4 p-4 bg-gray-100 dark:bg-gray-800 rounded">{result}</div>}
          </div>
        );
      }

      function Database() {
        const [lenses, setLenses] = React.useState([]);
        const [query, setQuery] = React.useState("");
        const [selected, setSelected] = React.useState([]);

        React.useEffect(() => {
          fetch("lenses.json").then(res => res.json()).then(data => setLenses(data));
        }, []);

        const results = lenses.filter(l => (l.brand + l.model + l.type + l.material + l.manufacturer).toLowerCase().includes(query.toLowerCase()));

        const toggleSelect = (lens) => {
          if (selected.find(s => s.model === lens.model)) {
            setSelected(selected.filter(s => s.model !== lens.model));
          } else if (selected.length < 2) {
            setSelected([...selected, lens]);
          }
        };

        return (
          <div className="p-6">
            <h2 className="text-2xl font-bold mb-4">Contact Lens Database</h2>
            <input className="border p-2 w-full mb-4" placeholder="Search brand, model, or feature" value={query} onChange={e => setQuery(e.target.value)} />
            <div className="grid md:grid-cols-2 gap-4">
              {results.map((lens, i) => (
                <div key={i} className="border p-4 rounded shadow bg-white dark:bg-gray-800">
                  <h3 className="font-bold">{lens.brand} {lens.model}</h3>
                  <p>{lens.type} â€“ {lens.material}</p>
                  <p>BC: {lens.base_curves.join(", ")} / DIA: {lens.diameters.join(", ")}</p>
                  <p>Water: {lens.water_content} â€“ {lens.manufacturer}</p>
                  <button onClick={() => toggleSelect(lens)} className="mt-2 px-3 py-1 bg-blue-500 text-white rounded">
                    {selected.find(s => s.model === lens.model) ? "Remove" : "Select for Compare"}
                  </button>
                </div>
              ))}
            </div>
          </div>
        );
      }

      function ColorBlindnessTest() {
        const plates = [
          { src: "images/ishihara/plate1.png", answer: "12" },
          { src: "images/ishihara/plate2.png", answer: "8" },
          { src: "images/ishihara/plate3.png", answer: "29" },
          { src: "images/ishihara/plate4.png", answer: "5" },
          { src: "images/ishihara/plate5.png", answer: "6" },
          { src: "images/ishihara/plate6.png", answer: "45" },
          { src: "images/ishihara/plate7.png", answer: "7" }
        ];

        const [step, setStep] = React.useState(0);
        const [answers, setAnswers] = React.useState([]);
        const [timer, setTimer] = React.useState(10);

        React.useEffect(() => {
          if (step < plates.length) {
            setTimer(10);
            const interval = setInterval(() => {
              setTimer(t => {
                if (t <= 1) {
                  clearInterval(interval);
                  handleAnswer("No answer");
                  return 0;
                }
                return t - 1;
              });
            }, 1000);
            return () => clearInterval(interval);
          }
        }, [step]);

        const handleAnswer = (ans) => {
          setAnswers([...answers, { plate: step+1, given: ans, correct: plates[step].answer }]);
          setStep(step+1);
        };

        if (step >= plates.length) {
          return (
            <div className="p-6">
              <h2 className="text-2xl font-bold mb-4">Results</h2>
              <ul className="space-y-2">
                {answers.map((a,i) => (
                  <li key={i} className="p-2 border rounded bg-white dark:bg-gray-700">
                    Plate {a.plate}: You said {a.given}, correct {a.correct}
                  </li>
                ))}
              </ul>
            </div>
          );
        }

        return (
          <div className="p-6 text-center">
            <h2 className="text-2xl font-bold mb-4">Plate {step+1}</h2>
            <p className="mb-2">Time left: {timer}s</p>
            <img src={plates[step].src} alt="Ishihara plate" className="mx-auto mb-4 max-w-xs border rounded" />
            <div className="space-x-2">
              {[plates[step].answer, "No answer"].map((opt,i) => (
                <button key={i} onClick={() => handleAnswer(opt)} className="px-4 py-2 bg-blue-500 text-white rounded">
                  {opt}
                </button>
              ))}
            </div>
          </div>
        );
      }

      function App() {
        return (
          <HashRouter>
            <Navbar />
            <Routes>
              <Route path="/" element={<Home />} />
              <Route path="/calculator" element={<Calculator />} />
              <Route path="/database" element={<Database />} />
              <Route path="/test" element={<ColorBlindnessTest />} />
            </Routes>
          </HashRouter>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>